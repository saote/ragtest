转矩脉动辨识 Edited
功能简介
需要完成其他所有辨识模式后，电机进入速度模式，调节位置增益使得位置跟随误差较小时，再启动转矩脉动辨识才能得到较好的效果，原因是电机先需要准确的进行位置控制，才能更好的建立转子绝对位置与转矩脉动的映射关系。运行过程中，电机会按照 1RPM 的转速进行旋转，期间对转矩脉动进行识别，辨识完成后停止运动，转矩脉动补偿数据将自动保存到 FLASH。
注意：如果是增量式 AB 编码器，因为无法得知转子绝对位置，每次重新上电需要重新进行转矩脉动辨识才能进行有效补偿。在只有霍尔传感器反馈的电机不建议进行转矩脉动辨识补偿，因为位置反馈的精度太低，补偿效果大打折扣。如果是 ABZ 编码器则辨识完成后，系统复位，电机需要旋转到 Z 相后，驱动器得到了转子的绝对位置信息才会对转矩脉动有效补偿。
对于电机控制来说，转矩脉动相当于负载干扰，所以转矩脉动辨识应当在空载下进行，辨识过程中也会对库伦静摩擦进行辨识。
注：转矩脉动补偿目前只支持带绝对位置信息的旋转电机。
字典说明
转矩脉动辨识模式相关参数
| 参数名称             | 字典名称                                  | 主索引 | 子索引 | 数据类型  | 参数范围                 | 读写权限 | 单位                             | 字典指令值含义                                                                                                                                                                                                                                                                                                                                                               |
| -------------------- | ----------------------------------------- | ------ | ------ | --------- | ------------------------ | -------- | -------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 运行模式指令         | Operation Mode Command                    | 0x6060 | 0x00   | INTEGER8  | -                        | RW       | -                                | 0x01：位置模式 0x03：速度模式 0x04：力矩模式 0x06：回零模式 0x0B：力控模式 0x3C：往复运动模式 0x16：模拟量控速度模式 0x17：模拟量控力矩模式 0x1F：脉冲控位置模式 0x3D：参考信号模式 0x2A：PWM 控速模式 0x3E：多段运行模式 0xFF：电气辨识 0xFE：方向辨识 0xFC：极对数辨识 0xFB：Z 相辨识 0xFD：霍尔辨识 0xFA：电角度辨识 0xF9：机械辨识 0xF7：机械特性辨识 0xF8：转矩脉动辨识 |
| 控制字               | DS402 Controlword                         | 0x6040 | 0x00   | UNS16     | -                        | RW       | -                                |                                                                                                                                                                                                                                                                                                                                                                              |
| 电机额定电流         | Motor Continuous Current                  | 0x6075 | 0x00   | INTEGER32 | 0~4294967295             | RW       | mA                               |                                                                                                                                                                                                                                                                                                                                                                              |
| 辨识电流幅度相对值   | Identification Current Amplitude Relative | 0x3503 | 0x00   | UNS32     | 1~200                    | RW       | %                                |                                                                                                                                                                                                                                                                                                                                                                              |
| 状态字               | DS402 Statusword                          | 0x6041 | 0x00   | UNS16     | -                        | RW       | -                                |                                                                                                                                                                                                                                                                                                                                                                              |
| 当前运行模式         | Operation Mode Actual                     | 0x6061 | 0x00   | INTEGER8  | -                        | RO       | -                                | 0x01：位置模式 0x03：速度模式 0x04：力矩模式 0x06：回零模式 0x0B：力控模式 0x3C：往复运动模式 0x16：模拟量控速度模式 0x17：模拟量控力矩模式 0x1F：脉冲控位置模式 0x3D：参考信号模式 0x2A：PWM 控速模式 0x3E：多段运行模式 0xFF：电气辨识 0xFE：方向辨识 0xFC：极对数辨识 0xFB：Z 相辨识 0xFD：霍尔辨识 0xFA：电角度辨识 0xF9：机械辨识 0xF7：机械特性辨识 0xF8：转矩脉动辨识 |
| 辨识状态             | Identification State                      | 0x3008 | 0x00   | UNS8      | 0~127                    | RO       | -                                | 0：启动开始空闲状态 1：辨识成功 2：电气辨识中 3：方向辨识中 4：机械辨识中 5：转矩脉动辨识中 255：错误状态                                                                                                                                                                                                                                                                    |
| 电机运行状态         | Motor Operation Status                    | 0x3005 | 0x00   | UNS8      | 0~255                    | RO       | -                                | 0：电机失能 1：电机使能                                                                                                                                                                                                                                                                                                                                                      |
| 转矩脉动补偿开关     | Torque Ripple Compensation Enable         | 0x3559 | 0x00   | UNS8      | 0~1                      | RW       | -                                | 0：关闭 1：开启                                                                                                                                                                                                                                                                                                                                                              |
| 摩擦补偿开关         | Friction Compensation Enable              | 0x355A | 0x00   | UNS8      | 0~1                      | RW       | -                                | 0：关闭 1：开启                                                                                                                                                                                                                                                                                                                                                              |
| 静摩擦对应的转矩电流 | Static Friction Current                   | 0x3531 | 0x00   | UNS32     | 0~4294967295             | RW       | mA                               |                                                                                                                                                                                                                                                                                                                                                                              |
| 电机端位置误差       | Motor Position Error Value                | 0x3573 | 0x00   | INTEGER32 | -2147483648 ~ 2147483647 | RO       | PosCU（位置坐标转换，用户单位）  |                                                                                                                                                                                                                                                                                                                                                                              |
| 负载端位置误差       | Load Position Error Value                 | 0x60F4 | 0x00   | INTEGER32 | -2147483648 ~ 2147483647 | RO       | PosCU（位置坐标转换，用户单位）  |                                                                                                                                                                                                                                                                                                                                                                              |
| 力矩指令值           | Torque Demand Value                       | 0x6074 | 0x00   | INTEGER16 | -32758~32767             | RO       | TqCU（转矩坐标转换，用户单位‰） |                                                                                                                                                                                                                                                                                                                                                                              |
| 电流当前值           | Current Actual Value                      | 0x6078 | 0x00   | INTEGER16 | -32758~32767             | RO       | TqCU（转矩坐标转换，用户单位‰） |                                                                                                                                                                                                                                                                                                                                                                              |
转矩脉动辨识模式指令参数
| 参数名称           | 字典名称                                  | 主索引 | 子索引 | 数据类型  | 参数范围     | 读写权限 | 单位 | 字典指令值含义                                                                                                                                                                                                                                                                                                                                                               |
| ------------------ | ----------------------------------------- | ------ | ------ | --------- | ------------ | -------- | ---- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 运行模式指令       | Operation Mode Command                    | 0x6060 | 0x00   | INTEGER8  | -128~127     | RW       | -    | 0x01：位置模式 0x03：速度模式 0x04：力矩模式 0x06：回零模式 0x0B：力控模式 0x3C：往复运动模式 0x16：模拟量控速度模式 0x17：模拟量控力矩模式 0x1F：脉冲控位置模式 0x3D：参考信号模式 0x2A：PWM 控速模式 0x3E：多段运行模式 0xFF：电气辨识 0xFE：方向辨识 0xFC：极对数辨识 0xFB：Z 相辨识 0xFD：霍尔辨识 0xFA：电角度辨识 0xF9：机械辨识 0xF7：机械特性辨识 0xF8：转矩脉动辨识 |
| 控制字             | DS402 Controlword                         | 0x6040 | 0x00   | UNS16     | 0~65535      | RW       | -    |                                                                                                                                                                                                                                                                                                                                                                              |
| 电机额定电流       | Motor Continuous Current                  | 0x6075 | 0x00   | INTEGER32 | 0~4294967295 | RW       | mA   |                                                                                                                                                                                                                                                                                                                                                                              |
| 辨识电流幅度相对值 | Identification Current Amplitude Relative | 0x3503 | 0x00   | UNS32     | 1~200        | RW       | %    |                                                                                                                                                                                                                                                                                                                                                                              |
| 转矩脉动补偿开关   | Torque Ripple Compensation Enable         | 0x3559 | 0x00   | UNS8      | 0~1          | RW       | -    | 0：关闭 1：开启                                                                                                                                                                                                                                                                                                                                                              |
| 摩擦补偿开关       | Friction Compensation Enable              | 0x355A | 0x00   | UNS8      | 0~1          | RW       | -    | 0：关闭 1：开启                                                                                                                                                                                                                                                                                                                                                              |
运行模式指令 6060h-00h
运动模式（0x6060-0x00）设置为 0xFF 时，表示电气辨识模式，此时当前运行模式（0x6061-0x00）为 0xFF。任意运行模式在使能或者失能的状态下都可以切换到电气辨识模式。
注：任何辨识模式都不响应暂停指令。
控制字 6040h-00h
控制字释义表
| bit   | 名称                    | 含义（中文）         | 描述                              |
| ----- | ----------------------- | -------------------- | --------------------------------- |
| 0     | switch on               | 伺服准备好           | 0：无效 1：有效                   |
| 1     | enable voltage          | 伺服已接通电源       | 0：无效 1：有效                   |
| 2     | quick  stop             | 快速停机             | 1：无效 0：有效                   |
| 3     | enable operation        | 伺服运行             | 0：无效 1：有效                   |
| 4~6   | operation mode specific | 不同运行模式含义不同 |                                   |
| 7     | fault                   | 故障                 | 0->1：有效 0->0、1->1、1->0：无效 |
| 8     | halt                    | 暂停                 | 0：无效 1：有效                   |
| 9~10  | reserved                | 预留                 |                                   |
| 11~15 | manufacturer specific   | 厂家自定义           |                                   |
转矩脉动辨识模式下 bit4~bit6
| bit | 含义     | 描述   |
| --- | -------- | ------ |
| 4   | reserved | 未定义 |
| 5   | reserved | 未定义 |
| 6   | reserved | 未定义 |
转矩脉动辨识模式下的控制命令和状态切换
| 操作         | 控制字 6040h | 驱动器状态         | 状态字 6041h |
| ------------ | ------------ | ------------------ | ------------ |
| 伺服失能     | 0x05         | switch on disabled | 0x250        |
| 伺服未准备好 | 0x06         | ready to switch on | 0x231        |
| 伺服使能     | 0x0F         | operation enable   | 0x237        |
电机额定电流 6075h-00h
用户可根据电机参数设置电机额定电流。
辨识电流幅度相对值 3503h-00h
辨识电流占电机额定电流的百分比。
应用于电气辨识、方向辨识、极对数辨识、霍尔辨识、Z 相辨识、电角度辨识、转矩脉动辨识。
注：在一般情况下不需要设置这个参数，在电机电感较小（小于 100uH），可以适当提高辨识电流幅值以获得更加准确得电机电感参数。
转矩脉动补偿开关 3559h-00h
开启转矩脉动补偿开关且转矩脉动辨识完成后，可以减小转矩脉动引起的位置误差。
摩擦补偿开关 355Ah-00h
开启摩擦补偿开关且转矩脉动辨识完成后，可以减小换向时引起的位置误差。
转矩脉动辨识模式监测参数
| 参数名称             | 字典名称                   | 主索引 | 子索引 | 数据类型  | 参数范围                 | 读写权限 | 单位                             | 字典指令值含义                                                                                                                                                                                                                                                                                                                                                               |
| -------------------- | -------------------------- | ------ | ------ | --------- | ------------------------ | -------- | -------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 状态字               | DS402 Statusword           | 0x6041 | 0x00   | UNS16     | -                        | RW       | -                                |                                                                                                                                                                                                                                                                                                                                                                              |
| 电机运行状态         | Motor Operation Status     | 0x3005 | 0x00   | UNS8      | 0~255                    | RO       | -                                |                                                                                                                                                                                                                                                                                                                                                                              |
| 当前运行模式         | Operation Mode Actual      | 0x6061 | 0x00   | INTEGER8  | -                        | RO       | -                                | 0x01：位置模式 0x03：速度模式 0x04：力矩模式 0x06：回零模式 0x0B：力控模式 0x3C：往复运动模式 0x16：模拟量控速度模式 0x17：模拟量控力矩模式 0x1F：脉冲控位置模式 0x3D：参考信号模式 0x2A：PWM 控速模式 0x3E：多段运行模式 0xFF：电气辨识 0xFE：方向辨识 0xFC：极对数辨识 0xFB：Z 相辨识 0xFD：霍尔辨识 0xFA：电角度辨识 0xF9：机械辨识 0xF7：机械特性辨识 0xF8：转矩脉动辨识 |
| 辨识状态             | Identification State       | 0x3008 | 0x00   | UNS8      | 0~127                    | RO       | -                                | 0：启动开始空闲状态 1：辨识成功 2：电气辨识中 3：方向辨识中 4：机械辨识中 5：转矩脉动辨识中 255：错误状态                                                                                                                                                                                                                                                                    |
| 静摩擦对应的转矩电流 | Static Friction Current    | 0x3531 | 0x00   | UNS32     | 0~4294967295             | RW       | mA                               |                                                                                                                                                                                                                                                                                                                                                                              |
| 电机端位置误差       | Motor Position Error Value | 0x3573 | 0x00   | INTEGER32 | -2147483648 ~ 2147483647 | RO       | PosCU（位置坐标转换，用户单位）  |                                                                                                                                                                                                                                                                                                                                                                              |
| 负载端位置误差       | Load Position Error Value  | 0x60F4 | 0x00   | INTEGER32 | -2147483648 ~ 2147483647 | RO       | PosCU（位置坐标转换，用户单位）  |                                                                                                                                                                                                                                                                                                                                                                              |
| 力矩指令值           | Torque Demand Value        | 0x6074 | 0x00   | INTEGER16 | -32758~32767             | RO       | TqCU（转矩坐标转换，用户单位‰） |                                                                                                                                                                                                                                                                                                                                                                              |
| 电流当前值           | Current Actual Value       | 0x6078 | 0x00   | INTEGER16 | -32758~32767             | RO       | TqCU（转矩坐标转换，用户单位‰） |                                                                                                                                                                                                                                                                                                                                                                              |
状态字 6041h-00h
状态字释义表
| bit   | 名称                    | 含义             | 描述                                                                          |
| ----- | ----------------------- | ---------------- | ----------------------------------------------------------------------------- |
| 0     | ready to switch on      | 伺服未准备好     | 0：无效 1：有效                                                               |
| 1     | switched on             | 伺服已接通 PWM   | 0：无效 1：有效                                                               |
| 2     | operation enabled       | 伺服使能         | 0：无效 1：有效                                                               |
| 3     | fault                   | 故障             | 0：无效 1：有效                                                               |
| 4     | voltage enabled         | 驱动器已接通电源 | 0：无效 1：有效                                                               |
| 5     | quick stop              | 急停             | 0：无效 1：有效                                                               |
| 6     | switch on disabled      | 伺服未接通 PWM   | 0：无效 1：有效                                                               |
| 7     | warning                 | 警告             | 0：无效 1：有效                                                               |
| 8     | manufacture specific    | 厂家自定义       | 预留，未定义                                                                  |
| 9     | remote                  | 远程控制         | 0：非 CANopen 模式 1：CANopen 远程控制模式                                    |
| 10    | target reached          | 目标已到达       | 0：无效 1：有效                                                               |
| 11    | internal limit active   | 软件内部位置超限 | 0：位置指令或反馈未到达软件内部位置限制 1：位置指令或反馈达到软件内部位置限制 |
| 12~13 | operation mode specific | 运行模式定义状态 | 与运行模式有关                                                                |
| 14~15 | manufacture specific    | 厂家自定义       | 预留，未定义                                                                  |
状态字bit0-bit3，bit5，bit6 定义
| Value(binary)指令值 | State状态      |
| --------------------------- | ---------------------- |
| xxxx xxxx x0xx 0000         | Not ready to switch on |
| xxxx xxxx x1xx 0000         | Switch on disabled     |
| xxxx xxxx x01x 0001         | Ready to switch on     |
| xxxx xxxx x01x 0011         | Switched on            |
| xxxx xxxx x01x 0111         | Operation enabled      |
| xxxx xxxx x00x 0111         | Quick stop active      |
| xxxx xxxx x0xx 1111         | Fault reaction active  |
| xxxx xxxx x0xx 1000         | Fault                  |
状态字Bit10、Bit12、Bit13 定义
| Bit | Value | Definition含义 |
| ------- | --------- | ---------------------- |
| 10      | -         | 未定义                 |
| 11      | -         | 未定义                 |
| 12      | -         | 未定义                 |
| 13      | -         | 未定义                 |
电机运行状态 3005h-00h
电机状态与伺服状态关系
| 402 状态               | 电机状态 |
| ---------------------- | -------- |
| Not ready to switch on | 电机失能 |
| Switch on disabled     | 电机失能 |
| Ready to switch on     | 电机失能 |
| Switched on            | 电机失能 |
| Operation enabled      | 电机使能 |
| Quick stop active      | 电机使能 |
| Fault                  | 电机失能 |
当前运行模式 6061h-00h
反馈当前运行模式，出厂设置为 0，表示空模式，空模式可以切换到任意模式。
当运行模式指令 = 0xFF(-1)时，当前运行模式 = 0xFF(-1)。
辨识状态 3005h-00h
| 值  | 含义             |
| --- | ---------------- |
| 0   | 启动开启空闲状态 |
| 1   | 辨识成功         |
| 2   | 电气辨识中       |
| 3   | 方向辨识中       |
| 4   | 机械辨识中       |
| 5   | 转矩脉动辨识中   |
| 255 | 辨识错误         |
静摩擦对应的转矩电流 3531h-00h
转矩脉动补偿辨识之后会得到一个摩擦对应的转矩电流，这个值也可以手动设置，效果就是在电流输出时增加补偿。运行力矩模式，设置一个非 0 的目标力矩，可以查看到力矩指令值与目标力矩不相等，不相等的就是补偿的部分。
电机端位置误差 3573h-00h
电机端位置误差 = 位置规划值 - 电机端位置当前值。
双编码器控制时，为编码器 1 的位置误差。
负载端位置误差 60F4h-00h
负载端位置误差 = 位置规划值 - 负载端位置当前值。
负载端位置误差：单编码器控制时，为编码器 1 位置误差。双编码器控制时，指编码器 2 的位置误差。
力矩指令值 6074h-00h
用于力矩规划。电机的输出力矩按照力矩指令值进行规划。
电流当前值 6078h-00h
驱动器当前电流值，受正向力矩限制和负向力矩限制。
当开启力矩限制时，-负向力矩限制相对值 * 电机额定电流 ≤ 当前电流值 ≤ 正向力矩限制相对值 * 电机额定电流。
状态字解析
通用定义（各个模式都通用）：
| bit15 | bit14 | bit13 | bit12 | bit11 | bit10 | bit9 | bit8 | bit7 | bit6 | bit5 | bit4 | bit3 | bit2 | bit1 | bit0 |
| ----- | ----- | ----- | ----- | ----- | ----- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 0     | 0     | 0     | 0     | 0     | 0     | 1    | 0    | 0    | 0    | 0    | 0    | 0    | 0    | 0    | 0    |
| ms    | ms    | oms   | oms   | ila   | tr    | rm   | ms   | w    | sod  | qs   | ve   | f    | oe   | so   | rtso |
ms = manufacturer-specific（厂家自定义）
oms = operation mode specific（模式定义）
ila = internal limit active（如果 bit11 置 1，则表明触发内部位置限制）
tr = target reached（如果 bit10 置 1，则表明目标到达）
rm = remote （远程控制。如果 bit9 置 1，则表示 CANopen 远程控制模式）
w = warning（如果 bit7 置 1，则表明警告）
sod = switch on disabled（如果 bit6 置 1，则表明伺服未接通 PWM）
qs = quick stop（如果 bit5 置 0，则表明急停）
ve = voltage enabled（如果 bit4 置 1，则表明驱动器已接通电源）
f = fault（如果 bit3 置 1，则表明处于错误状态）
oe = operation enabled（如果 bit2 置 1，则表明伺服运行）
so = switched on（如果 bit1 置 1，则表明伺服已接通 PWM）
rtso = ready to switch on（如果 bit0 置 1，则表明伺服未准备好）
状态字 bit0-bit3，bit5，bit6 定义
| Value(binary)       | State                  |
| ------------------- | ---------------------- |
| xxxx xxxx x0xx 0000 | Not ready to switch on |
| xxxx xxxx x1xx 0000 | Switch on disabled     |
| xxxx xxxx x01x 0001 | Ready to switch on     |
| xxxx xxxx x01x 0011 | Switched on            |
| xxxx xxxx x01x 0111 | Operation enabled      |
| xxxx xxxx x00x 0111 | Quick stop active      |
| xxxx xxxx x0xx 1111 | Fault reaction active  |
| xxxx xxxx x0xx 1000 | Fault                  |
状态字 Bit10、Bit12、Bit13 定义：
| Bit | Value | Definition                                                                                      |
| ------- | --------- | --------------------------------------------------------------------------------------------------- |
| 10      | 0         | Halt (Bit 8 in controlword) = 0: Target  not reached 控制字 bit8 = 0 时，表示目标位置或者速度未到达 |
|         |           | Halt (Bit 8 in controlword) = 1: Axis decelerates 控制字 bit8 = 1 时，表示轴减速中                  |
|         | 1         | Halt (Bit 8 in controlword) = 0: Target  reached 控制字 bit8 = 0 时，表示目标位置或速度已到达       |
|         |           | Halt (Bit 8 in controlword) = 1: Velocity of axis is 0 控制字 bit8 = 1 时，表示轴速度为 0           |
| 12      | 0         | Previous setpoint already processed, waiting for new setpoint                                       |
|         | 1         | Previous setpoint still in process, setpoint overwriting shall be accepted                          |
| 13      | 0         | No following error                                                                                  |
|         | 1         | Following error                                                                                     |
模式下控制字使用
模式动作对应的控制字：
| 动作            | 驱动器状态                         | 对应控制字 |
| ------------------- | -------------------------------------- | -------------- |
| 失能                | Switch on disabled->Ready to switch on | 0x06           |
| 失能-> 使能（启动） | Switch on disabled->Operation  enabled | 0x0F           |
|                     | Ready to switch on->Operation  enabled |                |
| 使能-> 失能         | Operation enabled->Ready to switch on  | 0x06           |
|                     | Operation enabled->Switch on disabled  | 0x05           |
| 故障-> 失能         | Fault->Switch on diabled               | 0x86           |
模式设置流程

以上媒体的描述: 这张图片展示了一个流程图，描述了一个系统或设备的操作流程。流程图中包含多个步骤和决策点，具体内容如下：

检测驱动器当前状态
查询状态字（{0x6041-0x00}）
决策点：状态是否为“Ready to switch on”？
如果否，发送控制字节0x06（{0x6040-0x00 = 0x06}），然后返回检测驱动器当前状态。
如果是，继续下一步。
设置脉冲控制字节模式（{0x6060-0x00 = 0xF8}）
使能电机
发送控制字节使能（{0x6040-0x00 = 0x0F}）
决策点：检查电机是否已经使能
如果否，返回使能电机步骤。
如果是，继续下一步。
查询电机状态（{0x3005-0x00}）
决策点：检查识别是否完成
如果否，返回使能电机步骤。
如果是，继续下一步。
查询识别状态（{0x3008-0x00}）
决策点：检查识别是否失败
如果是，发送控制字节清除错误（{0x6040-0x00 = 0x86}），然后返回使能电机步骤。
如果否，继续下一步。


发送控制字节失能（{0x6040-0x00 = 0x06}）

这个流程图详细描述了一个系统在启动和运行过程中需要执行的步骤和决策点。